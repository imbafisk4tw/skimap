<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Ski-P√§sse: Snow Card Tirol & SuperSkiCard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    
/* Filter-Box (Saisonkarten / Gletscher / √úberschneidung / Nahe M√ºnchen) */
.filter-box.leaflet-control{
  background:white;
  padding:8px 10px;
  border:1px solid #888;
  font-size:13px;
  line-height:1.4;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  border-radius:4px;
  width:190px;
  box-sizing:border-box;
}
.filter-box .title{
  font-weight:600;
  font-size:12px;
  margin-bottom:6px;
}
.filter-box label{
  display:flex;
  align-items:center;
  gap:6px;
  margin:4px 0;
  user-select:none;
}
.filter-box input[type="checkbox"]{
  margin:0;
}

/* Export-Box (aktueller Filter) */
.export-box.leaflet-control{
  background:white;
  padding:8px 10px;
  border:1px solid #888;
  font-size:13px;
  line-height:1.4;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  border-radius:4px;
  width:190px;
  box-sizing:border-box;
}
.export-box .title{
  font-weight:600;
  font-size:12px;
  margin-bottom:6px;
}
.export-box button{
  width:100%;
  padding:5px 6px;
  margin:4px 0 0 0;
  font-size:13px;
  border-radius:3px;
  border:1px solid #666;
  background:#f0f0f0;
  cursor:pointer;
}
.export-box button:hover{ background:#e0e0e0; }
.export-box .hint{
  margin-top:6px;
  font-size:11px;
  color:#444;
}
html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .legend-box {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 9999;
      background: white;
      padding: 10px;
      border: 1px solid #888;
      font-size: 13px;
      line-height: 1.4;
    }
    .search-box {
      position: fixed !important;
      top: 10px;
      left: 50px;
      z-index: 10000;
      background: white;
      padding: 8px;
      width: 360px;
      max-width: calc(100vw - 40px);
      box-sizing: border-box;
border: 1px solid #888;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
    }
    .search-box label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .search-box input {
      width: 100%;
padding: 4px 6px;
      font-size: 13px;
      border: 1px solid #bbb;
      border-radius: 3px;
      box-sizing: border-box;
    }
	
    
    .search-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .search-row input {
      flex: 1 1 auto;
      min-width: 0;
    }
    #clear-verbund-btn {
      flex: 0 0 auto;
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #666;
      border-radius: 3px;
      background: #f0f0f0;
      cursor: pointer;
      white-space: nowrap;
    }
    #clear-verbund-btn:disabled {
      opacity: 0.55;
      cursor: default;
    }
.slider-box {
      position: relative;
      bottom: 110px;        /* sitzt √ºber der Legende */
      left: 20px;
      z-index: 10000;
      background: white;
      padding: 8px 10px;
      border: 1px solid #888;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
      max-width: 260px;
      width: calc(100vw - 40px); /* mobil: passt sich an */
      box-sizing: border-box;
    }

    .slider-box label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .slider-box input[type="range"] {
      width: 100%;
    }
    .slider-box .time-label {
      margin-top: 4px;
      font-size: 12px;
      color: #444;
    }

    /* Box f√ºr Startadresse & Button */
    .home-box {
      position: fixed;
      bottom: 120px;           
      left: 20px;
      z-index: 10000;
      background: white;
      padding: 8px 10px;
      border: 1px solid #888;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
      max-width: 260px;
      width: calc(100vw - 40px);
      box-sizing: border-box;
    }
    .home-box label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .home-box input {
      width: 100%;
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid #bbb;
      border-radius: 3px;
      box-sizing: border-box;
      margin-bottom: 6px;
    }
    .home-box button {
      width: 100%;
      padding: 4px 6px;
      font-size: 13px;
      border-radius: 3px;
      border: 1px solid #666;
      background: #f0f0f0;
      cursor: pointer;
    }
    .home-box button:hover {
      background: #e0e0e0;
    }

    /* Counter unten rechts */
    .counter-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10000;
      background: white;
      padding: 6px 10px;
      border: 1px solid #888;
      font-size: 12px;
      line-height: 1.4;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
    }
  
    /* Responsive: Boxen bleiben im Viewport */
    @media (max-width: 720px) {
      .search-box,
      .home-box,
      .slider-box,
      .legend-box {
        left: 10px !important;
        right: 10px !important;
        width: auto !important;
        max-width: none !important;
      }
      .search-box input { width: 100% !important; }
      .slider-box { bottom: 120px !important; }
      .legend-box { bottom: 10px !important; }
      .counter-box { right: 10px !important; bottom: 10px !important; }
      .filter-box.leaflet-control,
      .export-box.leaflet-control {
        width: 170px !important;
      }
    }
</style>
</head>
<body>

<div id="map"></div>

<!-- Counter sichtbare Resorts -->
<div id="resort-counter" class="counter-box">
  0 / 0
</div>

<!-- Suchfeld -->
<div class="search-box">
  <label for="resort-search">Skigebiet suchen</label>
  <div class="search-row">
    <input
      id="resort-search"
      list="resort-datalist"
      type="text"
      placeholder="Name eingeben & Enter dr√ºcken..."
    />
    <button id="clear-verbund-btn" type="button" disabled>Verbundfilter aufheben</button>
  </div>
  <datalist id="resort-datalist"></datalist>
</div>

<!-- Startadresse & Button -->
<div class="home-box">
  <label for="home-input">Startadresse (Adresse oder lat,lon)</label>
  <input
    id="home-input"
    type="text"
    placeholder="z.B. M√ºnchen, Marienplatz oder 48.12,11.57"
  />
  <button id="btn-calc-times" type="button">Fahrzeiten berechnen</button>
</div>

<!-- Fahrzeit-Slider -->
<div class="slider-box">
  <label for="time-slider">Max. Fahrzeit ab M√ºnchen</label>
  <input id="time-slider" type="range" min="0" max="100" value="100" />
  <div id="time-slider-label" class="time-label">Voll (alle Gebiete)</div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script src="config.js"></script>

<script src="searchFilter.js"></script>

<script>
  // --------- Basis-Einstellungen ---------
  // ORS_API_KEY wird aus config.js gelesen (nicht in Git einchecken).
  const ORS_API_KEY = (window.APP_CONFIG && window.APP_CONFIG.ORS_API_KEY) ? window.APP_CONFIG.ORS_API_KEY : "DEIN_ORS_API_KEY";

  const MUC_LAT = 48.137;
  const MUC_LON = 11.575;
  const AVG_SPEED_KMH = 70.0;
  
  function getResortNameFromInput(raw) {
    if (!raw) return '';
    const parts = raw.split(/\s[‚Äì-]\s/);
    return parts[0].trim();
  }

  function toRad(x) {
    return x * Math.PI / 180;
  }

  function haversineKm(lat1, lon1, lat2, lon2) {
    const R = 6371.0;
    const phi1 = toRad(lat1);
    const phi2 = toRad(lat2);
    const dphi = toRad(lat2 - lat1);
    const dlambda = toRad(lon2 - lon1);
    const a = Math.sin(dphi / 2) ** 2 +
              Math.cos(phi1) * Math.cos(phi2) * Math.sin(dlambda / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }
  
  function buildDriveText(r) {
    let distTxt = "";
    if (r.distKm != null && isFinite(r.distKm)) {
      distTxt = `${Math.round(r.distKm)} km`;
    }
    let timeTxt = "";
    if (r.travelHours != null && isFinite(r.travelHours)) {
      timeTxt = fmtTime(r.travelHours);
    }

    if (distTxt && timeTxt) return `${distTxt} ¬∑ ca. ${timeTxt}`;
    if (distTxt)           return distTxt;
    if (timeTxt)           return "ca. " + timeTxt;
    return "keine Angabe";
  }

  function makePopupHtml(r) {
    const passes = [];
    if (r.sct) passes.push("Snow Card Tirol");
    if (r.ssc) passes.push("SuperSkiCard");
    if (r.nearMuc && !r.sct && !r.ssc) passes.push("Weitere Gebiete s√ºdlich von M√ºnchen");
    const passesStr = passes.length ? passes.join(", ") : "‚Äì";

    const driveTxt = buildDriveText(r);
    const mapsUrl = `https://www.google.com/maps?q=${r.lat},${r.lon}`;

    let websiteLine = "";
    if (r.website) {
      const url = r.website.startsWith("http") ? r.website : "https://" + r.website;
      const label = url.replace(/^https?:\/\//, "");
      websiteLine = `<b>Website:</b> <a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a><br/>`;
    }

    return `
      <div style="font-size:13px">
        <b>${r.name}</b><br/>
        <b>P√§sse:</b> ${passesStr}<br/>
        <b>Gletscher:</b> ${r.glacier ? "Ja" : "Nein"}<br/>
        ${websiteLine}
        <b>Ab Zuhause:</b> ${driveTxt}<br/>
        <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer">
          In Google Maps √∂ffnen
        </a>
      </div>
    `;
  }
  
  function fmtTime(hoursFloat) {
    const totalMin = Math.round(hoursFloat * 60);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return `${h}h ${m.toString().padStart(2, "0")}m`;
  }

  function norm(name) {
    return name
      .toLowerCase()
      .replace(/‚Äì/g, "-")
      .replace(/‚Äî/g, "-")
      .replace(/  +/g, " ")
      .trim();
  }

  // --------- Grunddaten ---------
  const sctList = [/* nur noch Referenz, echte Daten aus resorts.json */];
  const sscList = [];
  const nearMucList = [];

  const resorts = {};
  const resortMarkers = {};
  let minHours = Infinity;
  let maxHours = 0;

  const travelTimeCache = {};
  let originMarker = null;
  
  // Gesamtzahl der Resorts
  let totalResorts = 0;

  // Karte
  const map = L.map("map").setView([47.2, 12.2], 9);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap-Mitwirkende"
  }).addTo(map);
  // Ein Layer f√ºr alle Resort-Marker (Filter steuern Sichtbarkeit)
  const markerLayer = L.layerGroup().addTo(map);
  const COLOR_SCT   = "#9C2419";
  const COLOR_SSC   = "#004A8F";
  const COLOR_BOTH  = "#9C27B0";
  const COLOR_MUC   = "#2E7D32";
  const COLOR_OTHER = "#888888";

  // Counter aktualisieren
  function updateResortCounter() {
    const box = document.getElementById("resort-counter");
    if (!box) return;

    let visible = 0;
    Object.values(resortMarkers).forEach(marker => {
      if (map.hasLayer(marker)) {
        visible++;
      }
    });

    box.textContent = `${visible} / ${totalResorts}`;
  }
  function addResort(name, lat, lon, passType, isGlacier, nearMuc = false, website, groupId = null, groupName = null, entryType = null, entryName = null) {
    const key = norm(name);
    if (!resorts[key]) {
      resorts[key] = {
        name: name,
        lat: lat,
        lon: lon,
        sct: false,
        ssc: false,
        glacier: false,
        nearMuc: false,
        website: website || null,
        groupId: groupId || null,
        groupName: groupName || null,
        entryType: entryType || null,
        entryName: entryName || null
      };
    } else if (website && !resorts[key].website) {
      resorts[key].website = website;
    }
    
    // Gruppierung / Entrypoint (nur setzen, wenn noch nicht vorhanden)
    if (groupId && !resorts[key].groupId) resorts[key].groupId = groupId;
    if (groupName && !resorts[key].groupName) resorts[key].groupName = groupName;
    if (entryType && !resorts[key].entryType) resorts[key].entryType = entryType;
    if (entryName && !resorts[key].entryName) resorts[key].entryName = entryName;
if (passType === "SCT") resorts[key].sct = true;
    if (passType === "SSC") resorts[key].ssc = true;
    if (passType === "MUC") resorts[key].nearMuc = true;
    if (nearMuc) resorts[key].nearMuc = true;
    if (isGlacier) resorts[key].glacier = true;
  }

  function initResortsFromJson(list) {

    list.forEach(r => {
      const name    = r.name;
      const lat     = r.lat;
      const lon     = r.lon;

      const glacier = !!r.glacier;
      const sct     = !!r.sct;
      const ssc     = !!r.ssc;
      const nearMuc = !!r.nearMuc;

      const website = (typeof r.website === "string" && r.website.trim()) ? r.website.trim() : null;

      // Gruppierung / Entrypoints (neues Datenmodell)
      const groupId   = (typeof r.groupId === "string" && r.groupId.trim()) ? r.groupId.trim() : null;
      const groupName = (typeof r.groupName === "string" && r.groupName.trim()) ? r.groupName.trim() : null;
      const entryType = (typeof r.entryType === "string" && r.entryType.trim()) ? r.entryType.trim() : null;
      const entryName = (typeof r.entryName === "string" && r.entryName.trim()) ? r.entryName.trim() : null;

      if (sct) {
        addResort(name, lat, lon, "SCT", glacier, nearMuc, website, groupId, groupName, entryType, entryName);
      }
      if (ssc) {
        addResort(name, lat, lon, "SSC", glacier, nearMuc, website, groupId, groupName, entryType, entryName);
      }
      if (!sct && !ssc) {
        addResort(name, lat, lon, "MUC", glacier, nearMuc, website, groupId, groupName, entryType, entryName);
      }
    });
  }

  function loadResortsAndInit() {
    fetch("resorts.json")
      .then(resp => {
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        return resp.json();
      })
      .then(list => {
        initResortsFromJson(list);

        totalResorts = Object.keys(resorts).length;

        buildMarkers();
        if (typeof rebuildDatalist === "function") {
          rebuildDatalist();
        }
        updateTimeLabel(100);
        applyTimeFilter(100);
        if (typeof loadTravelTimesJson === "function") {
          loadTravelTimesJson();
        }
      })
      .catch(err => {
        console.error("Fehler beim Laden von resorts.json:", err);
        alert("Fehler beim Laden der Skigebiete (Details in Konsole).");
      });
  }

  function buildMarkers() {
    Object.values(resorts).forEach(r => {
      const passes = [];
      if (r.sct) passes.push("Snow Card Tirol");
      if (r.ssc) passes.push("SuperSkiCard");
      if (r.nearMuc && !r.sct && !r.ssc) passes.push("Extra: ab M√ºnchen");
      const passesStr = passes.length ? passes.join(", ") : "‚Äì";

      let color = COLOR_OTHER;
      if (r.sct && r.ssc)      color = COLOR_BOTH;
      else if (r.sct)          color = COLOR_SCT;
      else if (r.ssc)          color = COLOR_SSC;
      else if (r.nearMuc)      color = COLOR_MUC;

      const distKm   = haversineKm(MUC_LAT, MUC_LON, r.lat, r.lon);
      const estHours = distKm / AVG_SPEED_KMH;
      r.distKm = distKm;
      r.travelHours = estHours;
      if (estHours < minHours) minHours = estHours;
      if (estHours > maxHours) maxHours = estHours;

      const mapsUrl = `https://www.google.com/maps?q=${r.lat},${r.lon}`;
      const driveTxt = `${Math.round(distKm)} km ¬∑ ca. ${fmtTime(estHours)}`;

      let marker;

      if (r.glacier) {
        const glacierIcon = L.divIcon({
          html: `
            <div style="
              width: 26px;
              height: 26px;
              border-radius: 50%;
              border: 2px solid ${color};
              background: white;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 16px;
            ">
              ‚ùÑ
            </div>
          `,
          className: "",
          iconSize: [26, 26],
          iconAnchor: [13, 13],
          popupAnchor: [0, -13]
        });

        marker = L.marker([r.lat, r.lon], { icon: glacierIcon });
      } else {
        marker = L.circleMarker([r.lat, r.lon], {
          radius: 8,
          color: color,
          fillColor: color,
          fillOpacity: 0.95,
          weight: 2
        });
      }

      marker
        .bindPopup(() => makePopupHtml(r))
        .bindTooltip(`${r.name} (${passesStr})`);
      markerLayer.addLayer(marker);
      resortMarkers[norm(r.name)] = marker;
    });

    // einmal initial nach Markerbau updaten
    updateResortCounter();
  }
  const timeSlider = document.getElementById("time-slider");
  const overlays = {
  };

  if (Object.keys(overlays).length) {
    L.control.layers({}, overlays, { collapsed: false }).addTo(map);
  }
  // --------- Suche & Filter initialisieren (ausgelagert in searchFilter.js) ---------
  const ui = window.initSearchAndFilters({
    map,
    resorts,
    resortMarkers,
    markerLayer,
    fmtTime,
    norm,
    getMinHours: () => minHours,
    getMaxHours: () => maxHours,
    updateResortCounter,
    createFilterControl: true,
    createExportControl: true
  });
// Alte Funktionsnamen weiterhin verf√ºgbar halten (damit bestehender Code unver√§ndert bleibt)
  window.rebuildDatalist   = ui.rebuildDatalist;
  window.updateTimeLabel   = ui.updateTimeLabel;
  window.applyTimeFilter   = ui.applyTimeFilter;
  window.focusResortByName = ui.focusResortByName;
  // Suche & Filter wurden in searchFilter.js ausgelagert.

  function applyTravelTimesFromMap(ttMap) {
    const resortList = Object.values(resorts);
    minHours = Infinity;
    maxHours = 0;

    resortList.forEach(r => {
      const tt = ttMap[r.name];
      if (tt && typeof tt.hours === "number" && typeof tt.km === "number") {
        r.travelHours = tt.hours;
        r.distKm = tt.km;
        if (tt.hours < minHours) minHours = tt.hours;
        if (tt.hours > maxHours) maxHours = tt.hours;
      }
    });

    if (typeof rebuildDatalist === "function") {
      rebuildDatalist();
    }
    if (typeof timeSlider !== "undefined" && timeSlider) {
      timeSlider.value = 100;
    }
    updateTimeLabel(100);
    applyTimeFilter(100);
  }

  async function recalcTravelTimesFromOrigin() {
    const input = document.getElementById("home-input");
    const value = input.value.trim();

    let originLat;
    let originLon;

    if (!value) {
      originLat = MUC_LAT;
      originLon = MUC_LON;
    } else if (value.includes(",")) {
      const parts = value.split(",");
      originLat = parseFloat(parts[0]);
      originLon = parseFloat(parts[1]);
      if (!isFinite(originLat) || !isFinite(originLon)) {
        alert("Konnte Eingabe nicht als 'lat,lon' interpretieren.");
        return;
      }
    } else {
      if (!ORS_API_KEY || ORS_API_KEY === "DEIN_ORS_API_KEY") {
        alert("Bitte ORS_API_KEY in config.js eintragen.");
        return;
      }
      try {
        const url = "https://api.openrouteservice.org/geocode/search?api_key=" +
                    encodeURIComponent(ORS_API_KEY) +
                    "&text=" + encodeURIComponent(value) +
                    "&size=1";
        const resp = await fetch(url);
        if (!resp.ok) {
          throw new Error("Geocoding-Request fehlgeschlagen");
        }
        const data = await resp.json();
        const feats = data.features || [];
        if (!feats.length) {
          alert("Adresse konnte nicht gefunden werden.");
          return;
        }
        const coords = feats[0].geometry.coordinates;
        originLon = coords[0];
        originLat = coords[1];
      } catch (err) {
        console.error("Fehler beim Geocoding:", err);
        alert("Fehler beim Geocoding (Details in Konsole).");
        return;
      }
    }

    if (typeof map !== "undefined") {
      if (originMarker) {
        map.removeLayer(originMarker);
      }
      const originIcon = L.divIcon({
        html: `
          <div style="
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
          ">
            üè†
          </div>
        `,
        className: "",
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      originMarker = L.marker([originLat, originLon], { icon: originIcon })
        .addTo(map)
        .bindTooltip("Startpunkt", { permanent: false });
    }

    const key = originLat.toFixed(3) + "," + originLon.toFixed(3);

    if (travelTimeCache[key]) {
      applyTravelTimesFromMap(travelTimeCache[key]);
      return;
    }

    const resortList = Object.values(resorts);
    const locations = [[originLon, originLat]].concat(
      resortList.map(r => [r.lon, r.lat])
    );
    const body = {
      locations: locations,
      metrics: ["distance", "duration"],
      units: "km",
      sources: [0],
      destinations: resortList.map((_, idx) => idx + 1)
    };

    if (!ORS_API_KEY || ORS_API_KEY === "DEIN_ORS_API_KEY") {
      alert("Bitte ORS_API_KEY in config.js eintragen.");
      return;
    }

    try {
      const resp = await fetch("https://api.openrouteservice.org/v2/matrix/driving-car", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": ORS_API_KEY
        },
        body: JSON.stringify(body)
      });
      if (!resp.ok) {
        throw new Error("Matrix-Request fehlgeschlagen: " + resp.status);
      }
      const data = await resp.json();
      const durations = (data.durations && data.durations[0]) || [];
      const distances = (data.distances && data.distances[0]) || [];

      const ttMap = {};
      resortList.forEach((r, idx) => {
        const durSec = durations[idx];
        const distKm = distances[idx];
        if (typeof durSec === "number" && typeof distKm === "number") {
          const hours = durSec / 3600.0;
          ttMap[r.name] = { hours: hours, km: distKm };
        }
      });

      travelTimeCache[key] = ttMap;
      applyTravelTimesFromMap(ttMap);
    } catch (err) {
      console.error("Fehler beim Abrufen der Matrix:", err);
      alert("Fehler beim Abrufen der Fahrzeiten (Details in Konsole).");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btn-calc-times");
    if (btn) {
      btn.addEventListener("click", () => {
        recalcTravelTimesFromOrigin();
      });
    }
  });

  function loadTravelTimesJson() {
    fetch("travel_times.json")
      .then(resp => resp.json())
      .then(data => {
        Object.values(resorts).forEach(r => {
          const tt = data[r.name];
          if (tt) {
            if (typeof tt.hours === "number") {
              r.travelHours = tt.hours;
            }
            if (typeof tt.km === "number") {
              r.distKm = tt.km;
            }
          }
        });

        minHours = Infinity;
        maxHours = 0;
        Object.values(resorts).forEach(r => {
          if (r.travelHours != null && isFinite(r.travelHours)) {
            if (r.travelHours < minHours) minHours = r.travelHours;
            if (r.travelHours > maxHours) maxHours = r.travelHours;
          }
        });

        if (typeof rebuildDatalist === "function") {
          rebuildDatalist();
        }

        if (typeof timeSlider !== "undefined" && timeSlider) {
          timeSlider.value = 100;
        }
        updateTimeLabel(100);
        applyTimeFilter(100);
      })
      .catch(err => {
        console.error("Fehler beim Laden von travel_times.json, nutze Luftlinie:", err);
        updateTimeLabel(100);
        applyTimeFilter(100);
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadResortsAndInit();
  });

</script>
</body>
</html>
